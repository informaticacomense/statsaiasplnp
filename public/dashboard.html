<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Utente - StatsAIASPLnp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-green-600 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">üèÄ StatsAIASPLnp - Area Riservata</h1>
    <div>
      <span id="userName" class="mr-4"></span>
      <a href="profile.html" class="mr-4 underline">Profilo</a>
      <!-- Link admin visibili solo se ruolo=admin -->
      <a href="admin.html" id="adminLinkPartite" class="mr-4 underline hidden">‚öôÔ∏è Gestione Partite</a>
      <a href="utenti.html" id="adminLinkUtenti" class="mr-4 underline hidden">üë• Gestione Utenti</a>
      <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-700">Logout</button>
    </div>
  </nav>

  <!-- Avviso Club mancante -->
  <div id="alertClub" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded m-6">
    ‚ö†Ô∏è Ricordati di aggiornare il tuo profilo inserendo il <b>Club di Lavoro</b>.
    <a href="profile.html" class="underline ml-2">Vai al profilo</a>
  </div>

  <!-- Main -->
  <main class="p-6 max-w-6xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">üìÖ Crea o gestisci le tue partite</h2>

    <!-- Form creazione partita -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h3 class="text-lg font-bold mb-3">‚ûï Crea nuova partita</h3>
      <form id="createPartitaForm" class="grid grid-cols-2 gap-4">
        <input type="text" name="campionato" placeholder="Campionato *" class="border p-2 rounded col-span-2" required>
        <input type="text" name="girone" placeholder="Girone" class="border p-2 rounded">
        <input type="date" name="data_gara" class="border p-2 rounded" required>
        <input type="text" name="numero_gara" placeholder="Numero gara *" class="border p-2 rounded" required>
        <input type="text" name="squadra_a" placeholder="Squadra A *" class="border p-2 rounded" required>
        <input type="text" name="squadra_b" placeholder="Squadra B *" class="border p-2 rounded" required>
        <input type="text" name="campo_gioco" placeholder="Campo di gioco" class="border p-2 rounded">
        <input type="time" name="orario" class="border p-2 rounded">
        <button type="submit" class="col-span-2 bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700">Crea Partita</button>
      </form>
    </div>

    <!-- Filtri -->
    <div class="flex gap-4 mb-6 flex-wrap">
      <select id="filterCampionato" class="border p-2 rounded">
        <option value="">Tutti i Campionati</option>
      </select>
      <select id="filterGirone" class="border p-2 rounded">
        <option value="">Tutti i Gironi</option>
      </select>
      <select id="filterStato" class="border p-2 rounded">
        <option value="">Tutti gli Stati</option>
        <option value="da_giocare">Da giocare</option>
        <option value="in_corso">In corso</option>
        <option value="terminata">Terminate</option>
        <option value="revisionata">Revisionate</option>
        <option value="da_rivedere">Da rivedere</option>
      </select>
    </div>

    <div id="partiteContainer" class="space-y-6"></div>
  </main>

  <!-- Script -->
  <script>
    let currentUser = null;
    let iscrizioniUtente = [];
    let allPartite = [];

    async function loadUser() {
      const res = await fetch('/me');
      if (!res.ok) {
        window.location.href = "/";
        return;
      }
      currentUser = await res.json();
      document.getElementById("userName").innerText = currentUser.nome + " " + currentUser.cognome;

      // Mostra link admin se ruolo=admin
      if (currentUser.ruolo === "admin") {
        document.getElementById("adminLinkPartite").classList.remove("hidden");
        document.getElementById("adminLinkUtenti").classList.remove("hidden");
      }

      // Mostra avviso se manca club_appartenenza
      if (!currentUser.club_appartenenza || currentUser.club_appartenenza.trim() === "") {
        document.getElementById("alertClub").classList.remove("hidden");
      }

      await loadIscrizioniUtente();
      await loadPartite();
    }

    async function loadIscrizioniUtente() {
      const res = await fetch('/mie-iscrizioni');
      if (!res.ok) return;
      iscrizioniUtente = await res.json();
    }

    async function loadPartite() {
      const res = await fetch('/partite');
      allPartite = await res.json();
      populateFilters();
      renderPartite();
    }

    // --- Creazione partita ---
    document.getElementById("createPartitaForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const data = Object.fromEntries(new FormData(e.target).entries());
      const res = await fetch('/partite/crea', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      alert(await res.text());
      e.target.reset();
      loadPartite();
    });

    function populateFilters() {
      const campionati = [...new Set(allPartite.map(p => p.campionato).filter(Boolean))];
      const gironi = [...new Set(allPartite.map(p => p.girone).filter(Boolean))];

      const campSel = document.getElementById("filterCampionato");
      const girSel = document.getElementById("filterGirone");

      campSel.innerHTML = `<option value="">Tutti i Campionati</option>`;
      girSel.innerHTML = `<option value="">Tutti i Gironi</option>`;

      campionati.forEach(c => campSel.innerHTML += `<option value="${c}">${c}</option>`);
      gironi.forEach(g => girSel.innerHTML += `<option value="${g}">${g}</option>`);
    }

    function renderPartite() {
      const camp = document.getElementById("filterCampionato").value;
      const gir = document.getElementById("filterGirone").value;
      const stato = document.getElementById("filterStato").value;

      const container = document.getElementById("partiteContainer");
      container.innerHTML = "";

      let filtered = allPartite.filter(p => {
        if (camp && p.campionato !== camp) return false;
        if (gir && p.girone !== gir) return false;
        if (stato && p.stato !== stato) return false;
        return true;
      });

      if (filtered.length === 0) {
        container.innerHTML = "<p class='text-gray-500'>Nessuna partita trovata.</p>";
        return;
      }

      filtered.forEach(p => {
        const iscrizione = iscrizioniUtente.find(i => i.partita_id === p.id);

        let userSection = "";
        if (iscrizione) {
          userSection = `<p class="mt-2 text-green-700">‚úÖ Sei iscritto come <b>${iscrizione.ruolo}</b></p>`;
        } else {
          userSection = `<p class="mt-2 text-gray-600">Non sei iscritto a questa partita.</p>`;
        }

        container.innerHTML += `
          <div class="bg-white p-4 rounded shadow">
            <h3 class="text-lg font-bold">${p.campionato} - ${p.squadra_a} vs ${p.squadra_b}</h3>
            <p class="text-sm text-gray-600">Gara ${p.numero_gara} | Girone ${p.girone || '-'} | Campo: ${p.campo_gioco || '-'} | Orario: ${p.orario || '-'}</p>
            <p class="mt-1">üìå Stato: <span class="font-semibold">${p.stato}</span></p>
            ${userSection}
          </div>
        `;
      });
    }

    ["filterCampionato", "filterGirone", "filterStato"].forEach(id => {
      document.getElementById(id).addEventListener("change", renderPartite);
    });

    async function logout() {
      await fetch('/logout');
      window.location.href = '/';
    }

    loadUser();
  </script>
</body>
</html>
