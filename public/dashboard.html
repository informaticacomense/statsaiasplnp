<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Utente - StatsAIASPLnp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<!-- NAVBAR -->
<nav class="bg-green-600 text-white p-4 flex justify-between">
  <h1 class="text-xl font-bold">StatsAIASPLnp - Area Riservata</h1>
  <div>
    <span id="userName" class="mr-4"></span>
    <a href="profile.html" class="mr-4 underline">Profilo</a>
    <a href="admin.html" id="adminLink" class="mr-4 underline hidden">Gestione Partite</a>
    <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">Logout</button>
  </div>
</nav>

<!-- NOTIFICA REVISIONI -->
<div id="revisionNotice"
  class="hidden text-center text-red-700 font-semibold py-3 bg-red-100">
  ⚠️ Hai partite revisionate da confermare
</div>

<main class="p-6 max-w-7xl mx-auto space-y-8">

<!-- ================= FILTRI ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-4">Filtra partite</h2>

  <div class="flex flex-wrap gap-4 items-end">
    <select id="filterCampionato" class="border p-2 rounded" onchange="applyFilters()">
      <option value="">Campionato</option>
      <option value="A2">A2</option>
      <option value="Serie B">Serie B</option>
    </select>

    <select id="filterGirone" class="border p-2 rounded" onchange="applyFilters()">
      <option value="">Girone</option>
      <option value="UNICO">UNICO</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>

    <input type="date" id="filterData" class="border p-2 rounded" onchange="applyFilters()">

    <select id="filterRevision" class="border p-2 rounded" onchange="applyFilters()">
      <option value="">Revisioni (tutte)</option>
      <option value="revisionata">Solo revisionate</option>
      <option value="non_revisionata">Solo non revisionate</option>
      <option value="mie_revisionate">Solo mie revisionate</option>
    </select>

    <label class="flex items-center gap-2">
      <input type="checkbox" id="filterFuture" onchange="applyFilters()"> Solo future
    </label>

    <input type="text" id="filterSquadra"
      class="border p-2 rounded"
      placeholder="Cerca per squadra"
      oninput="applyFilters()">

    <button onclick="resetFilters()" class="bg-gray-200 px-3 py-2 rounded">Reset</button>
  </div>
</section>

<!-- ================= CREA PARTITA ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-3">Crea nuova partita</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <select id="cpCampionato" class="border p-2 rounded">
      <option value="A2">A2</option>
      <option value="Serie B">Serie B</option>
    </select>

    <select id="cpGirone" class="border p-2 rounded">
      <option value="UNICO">UNICO</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>

    <input type="date" id="cpData" class="border p-2 rounded">
    <input type="time" id="cpOra" class="border p-2 rounded">

    <input id="cpA" placeholder="Squadra casa" class="border p-2 rounded">
    <input id="cpB" placeholder="Squadra ospite" class="border p-2 rounded">

    <input id="cpCampo" placeholder="Campo" class="border p-2 rounded">
    <input id="cpNumero" placeholder="Numero gara" class="border p-2 rounded">

    <button onclick="creaPartita()"
      class="bg-green-600 text-white px-4 py-2 rounded md:col-span-3">
      Crea Partita
    </button>
  </div>
</section>

<!-- ================= ELENCO PARTITE ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-3">Elenco Partite</h2>
  <div id="partiteContainer" class="space-y-6"></div>
</section>

</main>

<script>
let currentUser=null;
let iscrizioniUtente=[];
let allPartite=[];

function formatDate(d){return new Date(d).toLocaleDateString("it-IT");}
function safeArr(v){try{return JSON.parse(v||"[]");}catch{return[];}}
function daysDiff(d){
  const a=new Date(d);const b=new Date();
  a.setHours(0,0,0,0);b.setHours(0,0,0,0);
  return Math.abs((a-b)/86400000);
}

async function loadUser(){
  const res=await fetch("/me");
  if(!res.ok) return location.href="/";
  currentUser=await res.json();
  userName.innerText=currentUser.nome+" "+currentUser.cognome;
  if(currentUser.ruolo==="admin") adminLink.classList.remove("hidden");

  iscrizioniUtente=await (await fetch("/mie-iscrizioni")).json();
  allPartite=await (await fetch("/partite")).json();

  updateRevisionNotice();
  renderPartite();
}

function miaRevisionataNonLetta(p){
  return p.stato==="revisionata" &&
    iscrizioniUtente.some(i=>i.partita_id===p.id) &&
    !safeArr(p.visualizzata_da).includes(currentUser.id);
}

function updateRevisionNotice(){
  revisionNotice.classList.toggle("hidden",
    allPartite.filter(miaRevisionataNonLetta).length===0);
}

function runFilters(list){
  const q=filterSquadra.value.toLowerCase().trim();
  return list.filter(p=>{
    if(filterCampionato.value && p.campionato!==filterCampionato.value) return false;
    if(filterGirone.value && p.girone!==filterGirone.value) return false;
    if(filterFuture.checked && p.data_gara < new Date().toISOString().slice(0,10)) return false;
    if(filterRevision.value==="mie_revisionate" && !miaRevisionataNonLetta(p)) return false;
    if(q){
      const a=p.squadra_a.toLowerCase();
      const b=p.squadra_b.toLowerCase();
      if(!a.includes(q)&&!b.includes(q)) return false;
    }
    return true;
  });
}

function renderPartite(){
  partiteContainer.innerHTML="";
  let list=runFilters(allPartite);

  if(filterSquadra.value.trim()){
    list.sort((a,b)=>daysDiff(a.data_gara)-daysDiff(b.data_gara));
  }

  list.sort((a,b)=>
    (miaRevisionataNonLetta(b)?1:0)-(miaRevisionataNonLetta(a)?1:0)
  );

  list.forEach(p=>renderCard(p));
}

function renderCard(p){
  const iscr=iscrizioniUtente.find(i=>i.partita_id===p.id);
  let html=`
  <div class="border p-4 rounded ${miaRevisionataNonLetta(p)?'bg-red-50 border-red-600':''}">
    <h3 class="font-bold">${p.campionato} - ${p.squadra_a} vs ${p.squadra_b}</h3>
    <p>${formatDate(p.data_gara)} ore ${p.orario||"-"} | Gara ${p.numero_gara||"-"}</p>
    <p>Stato: <b>${p.stato}</b>
    ${p.risultato_finale?` | Risultato: <b>${p.risultato_finale}</b>`:""}</p>`;

  if(miaRevisionataNonLetta(p)){
    html+=`
    <div class="mt-2 bg-yellow-100 p-3 rounded">
      <p><b>Revisione Admin</b></p>
      <p>${p.note_admin||""}</p>
      <button onclick="confermaVisualizzazione(${p.id})"
        class="mt-2 bg-orange-600 text-white px-3 py-1 rounded">
        Conferma lettura
      </button>
    </div>`;
  }

  if(!iscr){
    html+=`
    <button onclick="iscriviti(${p.id})"
      class="mt-2 bg-blue-600 text-white px-3 py-1 rounded">
      Registrati
    </button>`;
  } else {
    html+=`<p class="mt-2 text-green-700">Iscritto come ${iscr.ruolo}</p>`;

    if(iscr.ruolo==="caller"){
      html+=`
      <input id="ris-${p.id}" class="border p-2 w-full mt-2" placeholder="Risultato finale">
      <textarea id="note-${p.id}" class="border p-2 w-full mt-2" placeholder="Note"></textarea>
      <button onclick="fineCaller(${p.id})"
        class="bg-purple-600 text-white px-3 py-1 rounded mt-2">
        Termina gara
      </button>`;
    }

    if(iscr.ruolo==="statistician"){
      html+=`
      <label class="block mt-2">FILE FLS</label>
      <input type="file" id="fls-${p.id}">
      <label class="block mt-2">PDF del TABELLINO</label>
      <input type="file" id="pdf-${p.id}">
      <button onclick="fineStat(${p.id})"
        class="bg-purple-600 text-white px-3 py-1 rounded mt-2">
        Carica file
      </button>`;
    }
  }

  html+="</div>";
  partiteContainer.innerHTML+=html;
}

async function confermaVisualizzazione(id){
  await fetch("/partite/conferma-visualizzazione",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({partita_id:id})
  });
  loadUser();
}

async function iscriviti(id){
  await fetch("/partite/registrati",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({partita_id:id,ruolo:"caller",orario_arrivo:"00:00"})
  });
  loadUser();
}

async function fineCaller(id){
  await fetch("/partite/finegara",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      partita_id:id,
      risultato_finale:document.getElementById(`ris-${id}`).value,
      note:document.getElementById(`note-${id}`).value
    })
  });
  loadUser();
}

async function fineStat(id){
  const fd=new FormData();
  fd.append("partita_id",id);
  fd.append("file_stat",document.getElementById(`fls-${id}`).files[0]);
  fd.append("pdf_stat",document.getElementById(`pdf-${id}`).files[0]);
  await fetch("/partite/finegara",{method:"POST",body:fd});
  loadUser();
}

async function creaPartita(){
  await fetch("/partite/create",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      campionato:cpCampionato.value,
      girone:cpGirone.value,
      data_gara:cpData.value,
      orario:cpOra.value,
      squadra_a:cpA.value,
      squadra_b:cpB.value,
      campo_gioco:cpCampo.value,
      numero_gara:cpNumero.value
    })
  });
  loadUser();
}

async function logout(){await fetch("/logout");location.href="/";}

loadUser();
</script>

</body>
</html>
