<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Utenti - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-gray-800 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">üë• Gestione Utenti - StatsAIASPLnp</h1>
    <div class="flex gap-2">
      <a href="admin.html" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-800">‚öôÔ∏è Gestione Partite</a>
      <a href="crea_campi.html" class="bg-yellow-600 px-3 py-1 rounded hover:bg-yellow-800">üõ†Ô∏è Crea Campi</a>
      <a href="stampa_utenti.html" class="bg-green-600 px-3 py-1 rounded hover:bg-green-800">üñ®Ô∏è Stampa Utenti</a>
      <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-700">Logout</button>
    </div>
  </nav>

  <!-- Main -->
  <main class="p-6 max-w-7xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">üìã Elenco Utenti</h2>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow rounded-lg overflow-hidden text-sm">
        <thead class="bg-green-600 text-white">
          <tr>
            <th class="px-4 py-2 text-left">Nome</th>
            <th class="px-4 py-2 text-left">Email</th>
            <th class="px-4 py-2 text-left">Ruolo</th>
            <th class="px-4 py-2 text-left">Club</th>
            <th class="px-4 py-2 text-left">Sede Corso</th>
            <th class="px-4 py-2 text-left">Data Corso</th>
            <th class="px-4 py-2 text-left">Certificazione</th>
            <th class="px-4 py-2 text-left">Azioni</th>
          </tr>
        </thead>
        <tbody id="usersTable" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Partite -->
  <div id="modalPartite" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white rounded shadow-lg p-6 w-full max-w-2xl relative">
      <h3 class="text-xl font-bold mb-4">üìÖ Partite Utente</h3>
      <table class="w-full border text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-2 py-1">Data</th>
            <th class="px-2 py-1">Campionato</th>
            <th class="px-2 py-1">Gara</th>
            <th class="px-2 py-1">Squadre</th>
            <th class="px-2 py-1">Ruolo</th>
          </tr>
        </thead>
        <tbody id="partiteUtenteTable"></tbody>
      </table>
      <button onclick="chiudiModal()" class="mt-4 bg-red-600 text-white px-3 py-1 rounded hover:bg-red-800">Chiudi</button>
    </div>
  </div>

  <!-- Script -->
  <script>
    async function loadUsers() {
      const res = await fetch('/admin/users');
      if (!res.ok) {
        document.getElementById("usersTable").innerHTML =
          "<tr><td colspan='8' class='p-4 text-red-600'>Errore caricamento utenti</td></tr>";
        return;
      }
      const users = await res.json();
      const tbody = document.getElementById("usersTable");
      tbody.innerHTML = "";

      users.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td class="px-4 py-2">${u.nome} ${u.cognome}</td>
            <td class="px-4 py-2">${u.email}</td>
            <td class="px-4 py-2">
              <select onchange="aggiornaRuolo(${u.id}, this.value)" class="border rounded px-2 py-1">
                <option value="user" ${u.ruolo==='user'?'selected':''}>User</option>
                <option value="admin" ${u.ruolo==='admin'?'selected':''}>Admin</option>
              </select>
            </td>
            <td class="px-4 py-2">${u.club_appartenenza || "-"}</td>
            <td class="px-4 py-2">${u.sede_corso || "-"}</td>
            <td class="px-4 py-2">${u.data_corso ? new Date(u.data_corso).toLocaleDateString() : "-"}</td>
            <td class="px-4 py-2">
              ${u.certificato_lnp 
                ? '<span class="bg-green-600 text-white text-xs px-2 py-1 rounded">‚úÖ LNP</span>' 
                : '<span class="bg-gray-400 text-white text-xs px-2 py-1 rounded">No</span>'}
            </td>
            <td class="px-4 py-2 flex gap-2">
              <a href="utente_dettaglio.html?id=${u.id}" class="bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-800">‚úèÔ∏è Modifica</a>
              <button onclick="mostraPartite(${u.id})" class="bg-yellow-600 text-white px-2 py-1 rounded hover:bg-yellow-800">üìÖ Partite</button>
              <button onclick="eliminaUtente(${u.id})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-800">üóëÔ∏è Elimina</button>
            </td>
          </tr>
        `;
      });
    }

    async function mostraPartite(userId) {
      const res = await fetch(`/admin/users/${userId}/partite`);
      const partite = await res.json();
      const tbody = document.getElementById("partiteUtenteTable");
      tbody.innerHTML = "";

      if (partite.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center py-2 text-gray-500">Nessuna partita trovata</td></tr>`;
      } else {
        partite.forEach(p => {
          tbody.innerHTML += `
            <tr>
              <td class="px-2 py-1">${p.data_gara ? new Date(p.data_gara).toLocaleDateString() : "-"}</td>
              <td class="px-2 py-1">${p.campionato}</td>
              <td class="px-2 py-1">${p.numero_gara}</td>
              <td class="px-2 py-1">${p.squadra_a} vs ${p.squadra_b}</td>
              <td class="px-2 py-1">${p.ruolo}</td>
            </tr>
          `;
        });
      }

      document.getElementById("modalPartite").classList.remove("hidden");
    }

    function chiudiModal() {
      document.getElementById("modalPartite").classList.add("hidden");
    }

    async function aggiornaRuolo(userId, ruolo) {
      const res = await fetch('/admin/users/update-role', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: userId, ruolo })
      });
      alert(await res.text());
      loadUsers();
    }

    async function eliminaUtente(userId) {
      if (!confirm("Sei sicuro di voler eliminare questo utente?")) return;
      const res = await fetch(`/admin/users/delete/${userId}`, { method: 'DELETE' });
      alert(await res.text());
      loadUsers();
    }

    async function logout() {
      await fetch('/logout');
      window.location.href = "/";
    }

    loadUsers();
  </script>
</body>
</html>
