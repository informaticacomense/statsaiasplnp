<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Utenti - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- NAVBAR -->
  <nav class="bg-gray-800 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">üë• Gestione Utenti - StatsAIASPLnp</h1>
    <div class="flex gap-2">
      <a href="admin.html" class="bg-blue-600 px-3 py-1 rounded hover:bg-blue-800">‚öôÔ∏è Gestione Partite</a>
      <button onclick="stampaUtenti()" class="bg-green-600 px-3 py-1 rounded hover:bg-green-800">üñ®Ô∏è Stampa</button>
      <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-700">Logout</button>
    </div>
  </nav>

  <main class="p-6 max-w-6xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">üìã Elenco Utenti</h2>

    <!-- FILTRI -->
    <div class="mb-4 flex gap-3">
      <label class="flex items-center gap-2">
        <input type="radio" name="filtroCert" value="" checked onchange="renderUtenti()"> Tutti
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="filtroCert" value="cert" onchange="renderUtenti()"> Solo Certificati LNP
      </label>
      <label class="flex items-center gap-2">
        <input type="radio" name="filtroCert" value="noncert" onchange="renderUtenti()"> Solo NON Certificati
      </label>
    </div>

    <!-- TABELLA -->
    <div id="utentiContainer" class="bg-white p-4 rounded shadow"></div>
  </main>

  <script>
    let utenti = [];

    async function loadUtenti() {
      const res = await fetch('/admin/users');
      if (!res.ok) {
        document.getElementById("utentiContainer").innerHTML = "<p class='text-red-600'>Errore nel caricamento utenti.</p>";
        return;
      }
      utenti = await res.json();
      renderUtenti();
    }

    function renderUtenti() {
      const container = document.getElementById("utentiContainer");
      const filtro = document.querySelector("input[name='filtroCert']:checked").value;

      let lista = utenti;
      if (filtro === "cert") lista = utenti.filter(u => u.certificato_lnp);
      if (filtro === "noncert") lista = utenti.filter(u => !u.certificato_lnp);

      if (lista.length === 0) {
        container.innerHTML = "<p class='text-gray-500'>Nessun utente trovato.</p>";
        return;
      }

      container.innerHTML = `
        <table class="w-full border text-sm">
          <thead class="bg-gray-200">
            <tr>
              <th class="p-2 border">Nome</th>
              <th class="p-2 border">Cognome</th>
              <th class="p-2 border">Email</th>
              <th class="p-2 border">Societ√†</th>
              <th class="p-2 border">Certificato LNP</th>
            </tr>
          </thead>
          <tbody>
            ${lista.map(u => `
              <tr class="border-b">
                <td class="p-2 border">${u.nome}</td>
                <td class="p-2 border">${u.cognome}</td>
                <td class="p-2 border">${u.email}</td>
                <td class="p-2 border">${u.club_appartenenza || "-"}</td>
                <td class="p-2 border">${u.certificato_lnp ? "‚úÖ S√¨" : "‚ùå No"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;
    }

    function stampaUtenti() {
      let lista = [...utenti];

      // Ordina per societ√†
      lista.sort((a, b) => (a.club_appartenenza || "").localeCompare(b.club_appartenenza || ""));

      let contenuto = `
        <h1 style="text-align:center;">üìã Elenco Utenti</h1>
        <table border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:#eee;">
              <th>Societ√†</th>
              <th>Nome</th>
              <th>Cognome</th>
              <th>Certificato</th>
            </tr>
          </thead>
          <tbody>
            ${lista.map(u => `
              <tr>
                <td>${u.club_appartenenza || "-"}</td>
                <td>${u.nome}</td>
                <td>${u.cognome}</td>
                <td>${u.certificato_lnp ? "‚úÖ S√¨" : "‚ùå No"}</td>
              </tr>
            `).join("")}
          </tbody>
        </table>
      `;

      const w = window.open("", "_blank");
      w.document.write(contenuto);
      w.print();
    }

    async function logout() {
      await fetch('/logout');
      window.location.href = "/";
    }

    loadUtenti();
  </script>

</body>
</html>

