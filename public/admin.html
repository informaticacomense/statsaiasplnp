<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Gestione Partite - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

  <!-- Navbar -->
  <nav class="bg-gray-800 text-white p-4 flex justify-between">
    <h1 class="text-xl font-bold">‚öôÔ∏è Gestione Partite - StatsAIASPLnp</h1>
    <div class="flex gap-2">
      <a href="utenti.html" class="bg-green-600 px-3 py-1 rounded hover:bg-green-800">üë• Gestione Utenti</a>
      <button onclick="resetPartite()" class="bg-red-600 px-3 py-1 rounded hover:bg-red-800">‚ôªÔ∏è Reset Partite</button>
      <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded hover:bg-red-700">Logout</button>
    </div>
  </nav>

  <!-- Main -->
  <main class="p-6 max-w-7xl mx-auto">
    <h2 class="text-2xl font-bold mb-4">üìã Elenco Partite e Iscritti</h2>

    <!-- Upload CSV -->
    <div class="bg-white p-4 rounded shadow mb-6">
      <h3 class="font-bold mb-2">üìÇ Importa Partite da CSV</h3>
      <form id="csvForm" class="flex gap-2">
        <input type="file" name="partite_csv" class="border p-2 rounded" required>
        <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-800">Carica</button>
      </form>
      <p id="csvResp" class="text-green-600 mt-2"></p>
    </div>

    <!-- Tabella Partite -->
    <div class="overflow-x-auto">
      <table class="min-w-full bg-white shadow rounded-lg text-sm">
        <thead class="bg-blue-600 text-white">
          <tr>
            <th class="px-2 py-2">Data</th>
            <th class="px-2 py-2">Campionato</th>
            <th class="px-2 py-2">Gara</th>
            <th class="px-2 py-2">Squadre</th>
            <th class="px-2 py-2">Stato</th>
            <th class="px-2 py-2">Note Admin</th>
            <th class="px-2 py-2">Iscritti</th>
          </tr>
        </thead>
        <tbody id="partiteTable" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>
  </main>

  <script>
    async function loadPartite() {
      const res = await fetch('/report-partite');
      const tbody = document.getElementById("partiteTable");
      tbody.innerHTML = "";

      if (!res.ok) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-red-600">Errore nel caricamento partite</td></tr>`;
        return;
      }

      const rows = await res.json();
      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="p-4 text-gray-500">Nessuna partita trovata</td></tr>`;
        return;
      }

      // Raggruppa per partita
      const grouped = {};
      rows.forEach(r => {
        if (!grouped[r.partita_id]) grouped[r.partita_id] = { ...r, iscritti: [] };
        if (r.user_id) {
          grouped[r.partita_id].iscritti.push(r);
        }
      });

      Object.values(grouped).forEach(p => {
        let iscrittiHtml = "<p class='text-gray-500 italic'>Nessun iscritto</p>";
        if (p.iscritti.length > 0) {
          iscrittiHtml = p.iscritti.map(i => `
            <div class="border p-2 rounded mb-2">
              <p><b>${i.nome} ${i.cognome}</b> (${i.email})</p>
              <label class="text-sm">Ruolo:</label>
              <select onchange="aggiornaRuolo(${i.iscrizione_id}, this.value)" class="border rounded px-1 py-0.5">
                <option value="caller" ${i.ruolo==='caller'?'selected':''}>Caller</option>
                <option value="referee" ${i.ruolo==='referee'?'selected':''}>Referee</option>
                <option value="table" ${i.ruolo==='table'?'selected':''}>Table</option>
              </select>
            </div>
          `).join("");
        }

        tbody.innerHTML += `
          <tr>
            <td class="px-2 py-2">${p.data_gara ? new Date(p.data_gara).toLocaleDateString() : "-"}</td>
            <td class="px-2 py-2">${p.campionato || "-"}</td>
            <td class="px-2 py-2">${p.numero_gara || "-"}</td>
            <td class="px-2 py-2">${p.squadra_a} vs ${p.squadra_b}</td>
            <td class="px-2 py-2">
              <select onchange="aggiornaStato(${p.partita_id}, this.value, '${p.note_admin || ''}')" class="border rounded px-1 py-0.5">
                <option value="da_giocare" ${p.stato==='da_giocare'?'selected':''}>Da giocare</option>
                <option value="in_corso" ${p.stato==='in_corso'?'selected':''}>In corso</option>
                <option value="terminata" ${p.stato==='terminata'?'selected':''}>Terminata</option>
                <option value="revisionata" ${p.stato==='revisionata'?'selected':''}>Revisionata</option>
                <option value="da_rivedere" ${p.stato==='da_rivedere'?'selected':''}>Da rivedere</option>
              </select>
            </td>
            <td class="px-2 py-2">
              <input type="text" value="${p.note_admin || ''}" 
                onchange="aggiornaStato(${p.partita_id}, '${p.stato}', this.value)" 
                class="border px-1 py-0.5 rounded w-40">
            </td>
            <td class="px-2 py-2">${iscrittiHtml}</td>
          </tr>
        `;
      });
    }

    async function aggiornaStato(partitaId, stato, note) {
      const res = await fetch('/partite/stato', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ partita_id: partitaId, stato, note_admin: note })
      });
      alert(await res.text());
      loadPartite();
    }

    async function aggiornaRuolo(iscrizioneId, ruolo) {
      const res = await fetch('/iscrizioni/ruolo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ iscrizione_id: iscrizioneId, ruolo })
      });
      alert(await res.text());
      loadPartite();
    }

    async function resetPartite() {
      if (!confirm("‚ö†Ô∏è Vuoi eliminare tutte le partite e iscrizioni?")) return;
      const res = await fetch('/admin/reset', { method: 'POST' });
      alert(await res.text());
      loadPartite();
    }

    document.getElementById('csvForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const res = await fetch('/admin/upload-csv', {
        method: 'POST',
        body: formData
      });
      document.getElementById('csvResp').innerText = await res.text();
      loadPartite();
    });

    async function logout() {
      await fetch('/logout');
      window.location.href = "/";
    }

    loadPartite();
  </script>
</body>
</html>

