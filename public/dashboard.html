<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Utente - StatsAIASPLnp</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">

<!-- ================= NAVBAR ================= -->
<nav class="bg-green-600 text-white p-4 flex justify-between">
  <h1 class="text-xl font-bold">StatsAIASPLnp - Area Riservata</h1>
  <div>
    <span id="userName" class="mr-4"></span>
    <a href="profile.html" class="mr-4 underline">Profilo</a>
    <a href="admin.html" id="adminLink" class="mr-4 underline hidden">Gestione Partite</a>
    <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">Logout</button>
  </div>
</nav>

<!-- ================= NOTIFICA REVISIONI ================= -->
<div id="revisionNotice"
     class="hidden text-center text-red-700 font-semibold py-3 bg-red-100">
  ‚ö†Ô∏è Hai partite revisionate da confermare
</div>

<main class="p-6 max-w-7xl mx-auto space-y-8">

<!-- ================= FILTRI ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-4">Filtra partite</h2>

  <div class="flex flex-wrap gap-4 items-end">
    <select id="filterCampionato" class="border p-2 rounded">
      <option value="">Campionato</option>
      <option value="A2">A2</option>
      <option value="Serie B">Serie B</option>
    </select>

    <select id="filterGirone" class="border p-2 rounded">
      <option value="">Girone</option>
      <option value="UNICO">UNICO</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>

    <input type="date" id="filterData" class="border p-2 rounded">

    <select id="filterRevision" class="border p-2 rounded">
      <option value="">Revisioni</option>
      <option value="mie_revisionate">Mie revisionate</option>
    </select>

    <input type="text" id="filterSquadra"
           class="border p-2 rounded"
           placeholder="Cerca squadra">

    <button onclick="applyFilters()"
            class="bg-blue-600 text-white px-4 py-2 rounded">
      Cerca
    </button>

    <button onclick="resetFilters()"
            class="bg-gray-200 px-3 py-2 rounded">
      Reset
    </button>
  </div>
</section>

<!-- ================= CREA PARTITA ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-3">Crea nuova partita</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <select id="cpCampionato" class="border p-2 rounded">
      <option value="A2">A2</option>
      <option value="Serie B">Serie B</option>
    </select>

    <select id="cpGirone" class="border p-2 rounded">
      <option value="UNICO">UNICO</option>
      <option value="A">A</option>
      <option value="B">B</option>
    </select>

    <input type="date" id="cpData" class="border p-2 rounded">
    <input type="time" id="cpOra" class="border p-2 rounded">

    <input id="cpCasa" placeholder="Squadra casa" class="border p-2 rounded">
    <input id="cpOspite" placeholder="Squadra ospite" class="border p-2 rounded">

    <input id="cpCampo" placeholder="Campo" class="border p-2 rounded">
    <input id="cpNumero" placeholder="Numero gara" class="border p-2 rounded">

    <button onclick="creaPartita()"
            class="bg-green-600 text-white px-4 py-2 rounded md:col-span-3">
      Crea Partita
    </button>
  </div>
</section>

<!-- ================= ELENCO PARTITE ================= -->
<section class="bg-white p-4 rounded shadow">
  <h2 class="text-2xl font-bold mb-3">Elenco Partite</h2>
  <div id="partiteContainer" class="space-y-6"></div>
</section>

</main>

<script>
/* ================= VARIABILI GLOBALI ================= */
let currentUser = null;
let iscrizioniUtente = [];
let allPartite = [];

/* ================= UTILS ================= */
function normalizeArray(v){
  if(!v) return [];
  if(Array.isArray(v)) return v.map(Number);
  try { return JSON.parse(v).map(Number); } catch { return []; }
}
function formatDate(d){
  return new Date(d).toLocaleDateString("it-IT");
}

/* ================= LOAD ================= */
async function loadUser(){
  const res = await fetch("/me");
  if(!res.ok) return location.href="/";

  currentUser = await res.json();
  userName.innerText = currentUser.nome + " " + currentUser.cognome;

  if(currentUser.ruolo === "admin")
    adminLink.classList.remove("hidden");

  iscrizioniUtente = await (await fetch("/mie-iscrizioni")).json();
  allPartite = await (await fetch("/partite")).json();

  renderInitial();
}

/* ================= REVISIONI ================= */
function miaRevisionata(p){
  return p.stato === "revisionata" &&
         iscrizioniUtente.some(i => i.partita_id === p.id);
}
function miaRevisionataNonLetta(p){
  return miaRevisionata(p) &&
         !normalizeArray(p.visualizzata_da).includes(currentUser.id);
}

/* ================= APERTURA ================= */
function renderInitial(){
  const rev = allPartite.filter(miaRevisionataNonLetta);
  revisionNotice.classList.toggle("hidden", rev.length === 0);

  if(rev.length){
    renderList(rev);
  } else {
    partiteContainer.innerHTML =
      "<p class='text-gray-500'>Usa i filtri per cercare le partite.</p>";
  }
}

/* ================= FILTRI ================= */
function applyFilters(){
  let list = [...allPartite];

  if(filterRevision.value === "mie_revisionate")
    list = list.filter(miaRevisionata);

  if(filterCampionato.value)
    list = list.filter(p => p.campionato === filterCampionato.value);

  if(filterGirone.value)
    list = list.filter(p => p.girone === filterGirone.value);

  if(filterData.value)
    list = list.filter(p => p.data_gara >= filterData.value);

  if(filterSquadra.value){
    const q = filterSquadra.value.toLowerCase();
    list = list.filter(p =>
      p.squadra_a.toLowerCase().includes(q) ||
      p.squadra_b.toLowerCase().includes(q)
    );
  }

  renderList(list);
}

function resetFilters(){
  filterCampionato.value =
  filterGirone.value =
  filterData.value =
  filterSquadra.value =
  filterRevision.value = "";

  renderInitial();
}

/* ================= RENDER ================= */
function renderList(list){
  partiteContainer.innerHTML = "";

  if(!list.length){
    partiteContainer.innerHTML =
      "<p class='text-gray-500'>Nessuna partita trovata</p>";
    return;
  }

  list.forEach(renderCard);
}

function renderCard(p){
  const iscr = iscrizioniUtente.find(i => i.partita_id === p.id);
  const letta = normalizeArray(p.visualizzata_da).includes(currentUser.id);

  const iscritti = p.iscritti || [];
  const certCount = iscritti.filter(u => u.certificato_lnp).length;
  const lnpOK = certCount >= 2;

  let html = `
  <div class="border p-4 rounded
    ${lnpOK ? 'bg-green-50 border-green-600' : ''}
    ${miaRevisionataNonLetta(p) ? 'border-red-600 bg-red-50' : ''}">

    <h3 class="font-bold">${p.squadra_a} vs ${p.squadra_b}</h3>
    <p class="text-sm text-gray-600">
      ${formatDate(p.data_gara)} ore ${p.orario || "-"} |
      Gara ${p.numero_gara || "-"} | Girone ${p.girone || "-"}
    </p>

    <p class="mt-1">
      Stato: <b>${p.stato}</b>
      ${p.risultato_finale ? ` | Risultato: <b>${p.risultato_finale}</b>` : ""}
    </p>

    <p class="mt-1 font-semibold ${lnpOK ? 'text-green-700' : 'text-red-700'}">
      ${lnpOK ? '‚úÖ Requisito LNP soddisfatto (‚â•2 certificati)' : '‚ö†Ô∏è Certificati LNP insufficienti'}
    </p>

    <div class="mt-2 text-sm">
      <p class="font-semibold">Iscritti:</p>
      <ul class="list-disc ml-5">
        ${iscritti.map(u => `
          <li>
            ${u.nome} ${u.cognome} (${u.ruolo})
            ${u.certificato_lnp ? '‚úÖ LNP' : '‚ùå NO LNP'}
          </li>
        `).join("")}
      </ul>
    </div>`;

  /* REVISIONE */
  if(miaRevisionata(p)){
    html += `
    <div class="mt-3 p-3 bg-yellow-100 border border-yellow-400 rounded">
      <p class="font-semibold">üìå Esito revisione Admin</p>
      <p>${p.note_admin || "Nessuna nota"}</p>
      ${!letta ? `
        <button onclick="this.disabled=true; confermaVisualizzazione(${p.id})"
                class="mt-2 bg-orange-600 text-white px-3 py-1 rounded">
          Conferma lettura
        </button>
      ` : `
        <p class="mt-2 text-green-700 font-semibold">‚úî Revisione confermata</p>
      `}
    </div>`;
  }

  /* ISCRIZIONE */
  if(!iscr){
    html += `
    <button onclick="toggleIscr(${p.id})"
            class="mt-3 bg-blue-600 text-white px-3 py-1 rounded">
      Registrati
    </button>

    <div id="iscr-${p.id}" class="hidden mt-2 border p-3 rounded bg-gray-50">
      <label class="block text-sm">Ruolo</label>
      <select id="ruolo-${p.id}" class="border p-2 rounded w-full mb-2">
        <option value="caller">Caller</option>
        <option value="statistician">Statistician</option>
        <option value="standby">Standby</option>
      </select>

      <label class="block text-sm">Orario arrivo</label>
      <input type="time" id="orario-${p.id}" class="border p-2 rounded w-full mb-2">

      <button onclick="iscriviti(${p.id})"
              class="bg-green-600 text-white px-3 py-1 rounded">
        Conferma iscrizione
      </button>
    </div>`;
  } else {
    html += `<p class="mt-3 text-green-700">Iscritto come <b>${iscr.ruolo}</b></p>`;

    if(iscr.ruolo === "caller"){
      html += `
      <div class="mt-2 border p-3 rounded bg-gray-50">
        <label>Risultato finale</label>
        <input id="ris-${p.id}" class="border p-2 w-full mb-2">
        <label>Note</label>
        <textarea id="note-${p.id}" class="border p-2 w-full mb-2"></textarea>
        <button onclick="fineCaller(${p.id})"
                class="bg-purple-600 text-white px-3 py-1 rounded">
          Termina gara
        </button>
      </div>`;
    }

    if(iscr.ruolo === "statistician"){
      html += `
      <div class="mt-2 border p-3 rounded bg-gray-50">
        <label>FILE FLS</label>
        <input type="file" id="fls-${p.id}" class="mb-2">
        <label>PDF TABELLINO</label>
        <input type="file" id="pdf-${p.id}" class="mb-2">
        <button onclick="fineStat(${p.id})"
                class="bg-purple-600 text-white px-3 py-1 rounded">
          Carica file
        </button>
      </div>`;
    }
  }

  html += "</div>";
  partiteContainer.innerHTML += html;
}

/* ================= AZIONI ================= */
function toggleIscr(id){
  document.getElementById(`iscr-${id}`).classList.toggle("hidden");
}

async function iscriviti(id){
  await fetch("/partite/registrati",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      partita_id:id,
      ruolo:document.getElementById(`ruolo-${id}`).value,
      orario_arrivo:document.getElementById(`orario-${id}`).value
    })
  });
  loadUser();
}

async function confermaVisualizzazione(id){
  await fetch("/partite/conferma-visualizzazione",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ partita_id:id })
  });
  loadUser();
}

async function fineCaller(id){
  const fd = new FormData();
  fd.append("partita_id", id);
  fd.append("risultato_finale", document.getElementById(`ris-${id}`).value);
  fd.append("note", document.getElementById(`note-${id}`).value);
  await fetch("/partite/finegara",{ method:"POST", body:fd });
  loadUser();
}

async function fineStat(id){
  const fd = new FormData();
  fd.append("partita_id", id);
  fd.append("file_stat", document.getElementById(`fls-${id}`).files[0]);
  fd.append("pdf_stat", document.getElementById(`pdf-${id}`).files[0]);
  await fetch("/partite/finegara",{ method:"POST", body:fd });
  loadUser();
}

async function creaPartita(){
  await fetch("/partite/create",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      campionato:cpCampionato.value,
      girone:cpGirone.value,
      data_gara:cpData.value,
      orario:cpOra.value,
      squadra_a:cpCasa.value,
      squadra_b:cpOspite.value,
      campo_gioco:cpCampo.value,
      numero_gara:cpNumero.value
    })
  });
  loadUser();
}

async function logout(){
  await fetch("/logout");
  location.href="/";
}

loadUser();
</script>

</body>
</html>

